generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                              String       @id @default(uuid())
  email                           String       @unique
  name                            String?
  role                            Role         @default(TECHNICIAN)
  createdAt                       DateTime     @default(now())
  updatedAt                       DateTime     @updatedAt
  password                        String?
  commissionPercentageSales       Float        @default(0)
  commissionPercentageSupervision Float        @default(0)
  commissionPercentageUpsell      Float        @default(10) // Default 10% for upsells
  internalHourlyRate              Float        @default(0)
  canManageCommissions            Boolean      @default(false)
  canManageDivisions              Boolean      @default(false)
  
  // Granular Permissions
  canViewReports                  Boolean      @default(false)
  canManageTimesheets             Boolean      @default(false)
  canManageExpenses               Boolean      @default(false)
  canManageUsers                  Boolean      @default(false)
  
  isActive                        Boolean      @default(true)
  divisions                       Division[]   @default([EXTERMINATION])
  resetToken                      String?
  resetTokenExpiry                DateTime?
  commissions                     Commission[]
  salesJobs                       Job[]        @relation("JobSalesRep")
  supervisedJobs                  Job[]        @relation("JobSupervisor")
  jobs                            Job[]        @relation("JobToUser")
  soldQuotes                      Quote[]      @relation("QuoteSalesRep")
  activities                      JobActivity[]
  inventory                       InventoryItem[]
  audits                          InventoryAudit[]
  timesheets                      TimesheetEntry[]
  language                        Language     @default(FR)
  accesses                        UserDivisionAccess[]
}

model UserDivisionAccess {
  id                  String   @id @default(uuid())
  userId              String
  division            Division
  role                Role     @default(TECHNICIAN)

  // Granular overrides (per division)
  canViewReports      Boolean @default(false)
  canManageTimesheets Boolean @default(false)
  canManageExpenses   Boolean @default(false)
  canManageUsers      Boolean @default(false)
  canManageCommissions Boolean @default(false)
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, division])
}

model Client {
  id             String       @id @default(uuid())
  name           String
  email          String?
  phone          String?
  billingAddress String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  divisions      Division[]   @default([EXTERMINATION])
  language       Language     @default(FR)
  notes          ClientNote[]
  invoices       Invoice[]
  properties     Property[]
  quotes         Quote[]
  bookingLinks   BookingLink[]
}

model Property {
  id         String       @id @default(uuid())
  clientId   String
  address    String
  street     String?
  city       String?
  postalCode String?
  province   String?      @default("QC")
  country    String?      @default("Canada")
  type       PropertyType @default(RESIDENTIAL)
  accessInfo String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  latitude   Float?
  longitude  Float?
  jobs       Job[]
  client     Client       @relation(fields: [clientId], references: [id])
  quotes     Quote[]
  
  warrantyExpiresAt DateTime?
}

model Job {
  id                    String        @id @default(uuid())
  propertyId            String
  scheduledAt           DateTime
  scheduledEndAt        DateTime?
  status                JobStatus     @default(PENDING)
  description           String?

  // Real-Time Tracking
  enRouteAt             DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  travelDurationMinutes Int?          // ACTUAL travel time
  actualDurationMinutes Int?          // ACTUAL job duration

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  division              Division      @default(EXTERMINATION)
  grossMarginPercentage Float         @default(0)
  netSellingPrice       Float         @default(0)
  otherDirectCosts      Float         @default(0)
  salesRepId            String?
  supervisorId          String?
  totalJobCost          Float         @default(0)
  totalLaborCost        Float         @default(0)
  totalMaterialCost     Float         @default(0)
  totalProfit           Float         @default(0)
  commissions           Commission[]
  invoices              Invoice[]
  property              Property      @relation(fields: [propertyId], references: [id])
  salesRep              User?         @relation("JobSalesRep", fields: [salesRepId], references: [id])
  supervisor            User?         @relation("JobSupervisor", fields: [supervisorId], references: [id])
  notes                 JobNote[]
  photos                JobPhoto[]
  products              UsedProduct[]
  technicians           User[]        @relation("JobToUser")
  activities            JobActivity[]
  reviewRequest         ReviewRequest?
  
  // Completion Proofs
  signature             String?       @db.Text // Legacy (to be migrated or used as generic)
  clientSignature       String?       @db.Text
  technicianSignature   String?       @db.Text
  
  // Service Report Data
  reportNotes           String?       @db.Text // Public (Client facing)
  internalNotes         String?       @db.Text // Private (Team only)
  serviceReportUrl      String?

  isClientUnreachable   Boolean       @default(false)

  // Commission & Origin
  quoteId               String?
  quote                 Quote?        @relation(fields: [quoteId], references: [id])
  invoiceTriggered      Boolean       @default(false)

  // -- Recurring --
  parentJobId           String?
  parentJob             Job?          @relation("JobRecurrence", fields: [parentJobId], references: [id])
  childJobs             Job[]         @relation("JobRecurrence")
}

model JobNote {
  id        String   @id @default(uuid())
  jobId     String
  content   String
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id])
}

model JobPhoto {
  id        String   @id @default(uuid())
  jobId     String
  url       String
  caption   String?
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id])
}

model UsedProduct {
  id        String   @id @default(uuid())
  jobId     String
  productId String
  quantity  Float
  price     Float    @default(0) // Store the agreed price per unit (snapshot)
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  
  locations TreatmentLocation[]
  pests     TargetPest[]
  methods   ApplicationMethod[]
}

model TreatmentLocation {
  id           String        @id @default(uuid())
  name         String        @unique
  usedProducts UsedProduct[]
}

model TargetPest {
  id           String        @id @default(uuid())
  name         String        @unique
  usedProducts UsedProduct[]
}

model ApplicationMethod {
  id           String        @id @default(uuid())
  name         String        @unique
  usedProducts UsedProduct[]
}

model ClientNote {
  id        String   @id @default(uuid())
  clientId  String
  content   String
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id])
}

model Quote {
  id          String      @id @default(uuid())
  clientId    String
  propertyId  String?
  status      QuoteStatus @default(DRAFT)
  total       Float       @default(0)
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  discount    Float       @default(0)
  dueDate     DateTime?
  issuedDate  DateTime    @default(now())
  notes       String?
  poNumber    String?
  tax         Float       @default(0)
  terms       String?
  division    Division    @default(EXTERMINATION)
  number      String?     @unique
  client      Client      @relation(fields: [clientId], references: [id])
  property    Property?   @relation(fields: [propertyId], references: [id])
  items       QuoteItem[]
  signature   String?     // Base64 signature image
  signedAt    DateTime?
  
  // Sales Rep Relation
  salesRepId  String?
  salesRep    User?       @relation("QuoteSalesRep", fields: [salesRepId], references: [id])

  jobs        Job[]
}

model QuoteItem {
  id          String   @id @default(uuid())
  quoteId     String
  productId   String
  quantity    Float
  price       Float
  createdAt   DateTime @default(now())
  description String?
  taxRate     Float    @default(0)
  unitCost    Float    @default(0)
  isUpsell    Boolean  @default(false)
  product     Product  @relation(fields: [productId], references: [id])
  quote       Quote    @relation(fields: [quoteId], references: [id])
}

model Invoice {
  id          String        @id @default(uuid())
  clientId    String
  jobId       String?
  status      InvoiceStatus @default(DRAFT)
  total       Float         @default(0)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  discount    Float         @default(0)
  dueDate     DateTime?
  issuedDate  DateTime      @default(now())
  notes       String?
  poNumber    String?
  tax         Float         @default(0)
  terms       String?
  division    Division      @default(EXTERMINATION)
  number      String?       @unique
  client      Client        @relation(fields: [clientId], references: [id])
  job         Job?          @relation(fields: [jobId], references: [id])
  items       InvoiceItem[]
  transactions Transaction[]
  amountPaid  Float         @default(0)
}

model Transaction {
  id        String          @id @default(uuid())
  invoiceId String
  amount    Float
  date      DateTime        @default(now())
  method    PaymentMethod
  type      TransactionType
  note      String?
  createdAt DateTime        @default(now())
  invoice   Invoice         @relation(fields: [invoiceId], references: [id])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  productId   String
  quantity    Float
  price       Float
  createdAt   DateTime @default(now())
  description String?
  taxRate     Float    @default(0)
  unitCost    Float    @default(0)
  isUpsell    Boolean  @default(false)
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])
}

model Commission {
  id         String           @id @default(uuid())
  jobId      String
  userId     String
  role       CommissionRole
  baseAmount Float
  percentage Float
  amount     Float
  status     CommissionStatus @default(PENDING)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  job        Job              @relation(fields: [jobId], references: [id])
  user       User             @relation(fields: [userId], references: [id])
}

model JobActivity {
  id        String   @id @default(uuid())
  jobId     String
  userId    String?
  action    String
  details   String?
  createdAt DateTime @default(now())
  job       Job      @relation(fields: [jobId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])
}

model Product {
  id           String        @id @default(uuid())
  name         String
  description  String?
  unit         String
  usageDescription String?
  activeIngredient String?
  recommendedConcentration String?
  stock        Int           @default(0) // Kept for legacy/global view, but InventoryItem is source of truth
  warrantyInfo String?       // Template text for Invoices
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  price        Float         @default(0)
  division     Division      @default(EXTERMINATION)
  cost         Float         @default(0)
  type         ProductType   @default(CONSUMABLE)
  isCommissionEligible Boolean @default(false)
  durationMinutes Int           @default(60) // For Smart Scheduling (avg time)
  minTechnicians Int           @default(1)  // For Smart Scheduling (manpower)

  // -- Service Categorization --
  pestType        PestType?
  category        ServiceCategory? @default(CURATIVE)
  tier            ServiceTier?    @default(STANDARD)
  
  // -- Warranty & Visits --
  warrantyMonths  Int?
  warrantyDetails String?
  numberOfVisits  Int             @default(1)
  
  // -- Recurring Service Blueprint --
  isRecurring            Boolean @default(false) 
  recurrenceIntervalDays Int?    // e.g. 14 for bi-weekly
  
  // -- Seasonality --
  seasonStartMonth       Int?    // 1 (Jan) to 12 (Dec)
  seasonEndMonth         Int?    // 1 (Jan) to 12 (Dec)

  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]
  usedIn       UsedProduct[]
  inventory    InventoryItem[]
  auditItems   InventoryAuditItem[]
  seriesSteps  SeriesStep[]
  
  // Smart Inventory Relations
  materialsNeeded ServiceMaterial[] @relation("ServiceToMaterial")
  usedInServices  ServiceMaterial[] @relation("MaterialToService")

  // -- Bundles/Packages (Included Services) --
  isPackage            Boolean           @default(false)
  includedServices     IncludedService[] @relation("ParentService")
  includedInPackages   IncludedService[] @relation("ChildService")
  
  // -- Container Logic --
  containerSize        Float?            // e.g. 500 (ml) or 300 (g). Used to convert UI "Bottles" to stored "Total Units"
  
  // -- PDS / Preparation --
  preparationListUrl   String?
}

model IncludedService {
  id              String  @id @default(uuid())
  parentProductId String
  childProductId  String
  quantity        Int     @default(1)
  
  // Timeline Blueprint fields
  order           Int           @default(1)
  delayDays       Int           @default(0)
  seasonality     Seasonality   @default(ALL_YEAR)
  isWeatherDependent Boolean    @default(false)
  
  parentProduct   Product @relation("ParentService", fields: [parentProductId], references: [id])
  childProduct    Product @relation("ChildService", fields: [childProductId], references: [id])

  // Removed unique constraint to allow multiple of same service (e.g. 4 treatments of same type)
  @@index([parentProductId])
}

model ServiceMaterial {
  id          String  @id @default(uuid())
  serviceId   String
  materialId  String
  quantity    Float   // Expected quantity per 1 unit of Service
  
  service     Product @relation("ServiceToMaterial", fields: [serviceId], references: [id])
  material    Product @relation("MaterialToService", fields: [materialId], references: [id])

  @@unique([serviceId, materialId])
}

model InventoryItem {
  id        String   @id @default(uuid())
  productId String
  userId    String?  // If null, belongs to Warehouse
  quantity  Int      @default(0)
  updatedAt DateTime @updatedAt

  product   Product  @relation(fields: [productId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@unique([productId, userId]) // One record per product per user (or warehouse)
}

model InventoryAudit {
  id           String               @id @default(uuid())
  technicianId String
  date         DateTime             @default(now())
  status       AuditStatus          @default(PENDING)
  notes        String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  
  technician   User                 @relation(fields: [technicianId], references: [id])
  items        InventoryAuditItem[]
}

model InventoryAuditItem {
  id               String         @id @default(uuid())
  auditId          String
  productId        String
  expectedQuantity Int
  actualQuantity   Int
  notes            String?

  audit            InventoryAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  product          Product        @relation(fields: [productId], references: [id])
}

enum ProductType {
  CONSUMABLE
  EQUIPMENT
  SERVICE
}

enum AuditStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
}

// ... (Existing enums)
enum Role {
  ADMIN
  OFFICE
  TECHNICIAN
}

enum JobStatus {
  PENDING
  SCHEDULED
  EN_ROUTE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
}

enum Division {
  EXTERMINATION
  ENTREPRISES
  RENOVATION
}

enum Language {
  EN
  FR
}

enum PestType {
  MICE
  RAT
  ANTS
  BEDBUGS
  COCKROACHES
  SPIDERS
  WASPS
  OTHER
}

enum ServiceCategory {
  CURATIVE
  PREVENTATIVE
  MAINTENANCE
  INSPECTION
}

enum ServiceTier {
  STANDARD
  PREMIUM
  ECO
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
}

enum ReviewStatus {
  PENDING
  CLICKED
  SUBMITTED_INTERNAL
  REDIRECTED_GOOGLE
}

model ReviewRequest {
  id        String       @id @default(uuid())
  jobId     String       @unique
  token     String       @unique @default(uuid())
  score     Int?         // 1-5
  feedback  String?      @db.Text
  status    ReviewStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  
  job       Job          @relation(fields: [jobId], references: [id])
}

enum Seasonality {
  ALL_YEAR
  SPRING_ONLY // Job must happen in active season (e.g. April-Nov)
}

model ProductSeries {
  id          String       @id @default(uuid())
  name        String
  description String?
  steps       SeriesStep[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model SeriesStep {
  id             String        @id @default(uuid())
  seriesId       String
  productId      String
  order          Int           // 1, 2, 3
  delayDays      Int           // Days after previous step (0 for first step)
  seasonality    Seasonality   @default(ALL_YEAR)
  isWeatherDependent Boolean   @default(false)
  
  series         ProductSeries @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  product        Product       @relation(fields: [productId], references: [id])
}

model BookingLink {
  id        String   @id @default(uuid())
  clientId  String
  token     String   @unique @default(uuid())
  status    String   @default("ACTIVE") // ACTIVE, USED, EXPIRED
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  client    Client   @relation(fields: [clientId], references: [id])
}

model WarrantyTemplate {
  id        String   @id @default(uuid())
  name      String
  text      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  PARTIALLY_PAID
}

enum PaymentMethod {
  CARD
  CASH
  TRANSFER
  CHECK
  OTHER
}

enum TransactionType {
  PAYMENT
  REFUND
}

enum CommissionRole {
  SALES
  SUPERVISION
  UPSELL
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
}

model TimesheetEntry {
  id        String          @id @default(uuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id])
  startTime DateTime
  endTime   DateTime?
  startLat  Float?
  startLng  Float?
  endLat    Float?
  endLng    Float?
  status    TimesheetStatus @default(OPEN)
  duration  Int?            // Duration in minutes
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  startKm   Int?
  endKm     Int?
  startOdometerPhotoId String?
  endOdometerPhotoId   String?
  startLocation String?
  endLocation   String?
  breadcrumbs   GPSBreadcrumb[]
}

model GPSBreadcrumb {
  id          String   @id @default(uuid())
  timesheetId String
  latitude    Float
  longitude   Float
  timestamp   DateTime @default(now())
  speed       Float?
  heading     Float?
  accuracy    Float?
  timesheet   TimesheetEntry @relation(fields: [timesheetId], references: [id])
}

enum TimesheetStatus {
  OPEN
  SUBMITTED
  APPROVED
  REJECTED
}

model Expense {
  id          String   @id @default(uuid())
  description String
  amount      Float
  date        DateTime @default(now())
  category    String   // Rent, Gas, Insurance, Marketing, Equipment, etc.
  accountingCode String? // T2125/T2 Code (e.g. "8521")
  division    Division? // Optional: Link to specific division if applicable
  frequency   ExpenseFrequency @default(ONCE)
  nextOccurrence DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Potential future links
  receiptUrl  String?
  paymentMethod String @default("CREDIT_CARD") // Credit, Cash, Transfer...
}

enum ExpenseFrequency {
  ONCE
  WEEKLY
  BIWEEKLY
  MONTHLY
  YEARLY
}
